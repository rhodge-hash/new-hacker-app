
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repo-viz</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            background-color: #1a1a1a;
            color: #f0f0f0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        #ui-container {
            display: flex;
            flex-direction: column;
            padding: 10px;
            background: #252526;
            border-bottom: 1px solid #333;
        }

        #input-area {
            width: 100%;
            height: 100px;
            background: #000;
            color: #f0f0f0;
            border: 1px solid #555;
            padding: 8px;
            box-sizing: border-box;
            font-family: monospace;
            resize: vertical;
        }

        #buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        button {
            padding: 8px 12px;
            background-color: #333;
            color: #f0f0f0;
            border: 1px solid #555;
            cursor: pointer;
            border-radius: 4px;
            flex-grow: 1;
        }

        button:hover {
            background-color: #555;
        }

        button:disabled {
            background-color: #222;
            color: #666;
            cursor: not-allowed;
        }

        #visualization-container {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        #color-key {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 10;
        }

        .key-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .key-box {
            width: 15px;
            height: 15px;
            margin-right: 8px;
            border: 1px solid #aaa;
        }

        .cube-label {
            color: white;
            padding: 2px 5px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 3px;
            font-size: 12px;
            white-space: nowrap;
        }

        #details-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            border: 1px solid #444;
            padding: 20px;
            border-radius: 8px;
            z-index: 100;
            display: none;
            max-width: 300px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #details-modal pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            font-size: 14px;
        }

        #close-modal {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            #ui-container {
                padding: 5px;
            }

            #buttons-container {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            #color-key {
                font-size: 12px;
                padding: 8px;
            }

            .key-box {
                width: 12px;
                height: 12px;
            }
        }
    </style>
</head>
<body>

    <div id="ui-container">
        <textarea id="input-area" placeholder='Paste your repository JSON here. Example: {"name": "root", "type": "folder", "children": [{"name": "src", "type": "folder", "children": [{"name": "index.js", "type": "file"}]}]}'></textarea>
        <div id="buttons-container">
            <button id="load-btn">Load Visualization</button>
            <button id="undo-btn" disabled>Undo</button>
            <button id="redo-btn" disabled>Redo</button>
            <button id="download-btn">Download Image</button>
            <button id="share-btn">Share Link</button>
        </div>
    </div>

    <div id="visualization-container">
        <div id="color-key"></div>
        <div id="details-modal">
            <button id="close-modal">&times;</button>
            <h4>File Details</h4>
            <pre id="details-content"></pre>
        </div>
    </div>

    <script type="importmap">
        {
          "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.155.0/examples/jsm/"
          }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

        let scene, camera, renderer, controls, labelRenderer;
        let raycaster, mouse;
        const visualizationContainer = document.getElementById('visualization-container');
        const inputArea = document.getElementById('input-area');
        const loadBtn = document.getElementById('load-btn');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        const downloadBtn = document.getElementById('download-btn');
        const shareBtn = document.getElementById('share-btn');
        const detailsModal = document.getElementById('details-modal');
        const detailsContent = document.getElementById('details-content');
        const closeModalBtn = document.getElementById('close-modal');
        const colorKey = document.getElementById('color-key');

        let history = [];
        let historyIndex = -1;
        let currentRepoData;
        let cubeMap = new Map();

        const colorMap = {
            folder: '#2ecc71',
            file: '#f1c40f',
            js: '#f39c12',
            css: '#3498db',
            html: '#e74c3c',
            json: '#9b59b6',
            default: '#7f8c8d'
        };

        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);

            // Camera setup
            camera = new THREE.PerspectiveCamera(75, visualizationContainer.clientWidth / visualizationContainer.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 5);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(visualizationContainer.clientWidth, visualizationContainer.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            visualizationContainer.appendChild(renderer.domElement);

            // Label Renderer
            labelRenderer = new CSS2DRenderer();
            labelRenderer.setSize(visualizationContainer.clientWidth, visualizationContainer.clientHeight);
            labelRenderer.domElement.style.position = 'absolute';
            labelRenderer.domElement.style.top = '0px';
            labelRenderer.domElement.style.pointerEvents = 'none';
            visualizationContainer.appendChild(labelRenderer.domElement);

            // Controls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);

            // Raycaster for interaction
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // Event Listeners
            loadBtn.addEventListener('click', loadVisualization);
            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);
            downloadBtn.addEventListener('click', downloadImage);
            shareBtn.addEventListener('click', shareLink);
            closeModalBtn.addEventListener('click', () => detailsModal.style.display = 'none');
            renderer.domElement.addEventListener('pointerdown', onPointerDown);
            window.addEventListener('resize', onWindowResize);

            // Initial render
            animate();

            // Update color key
            updateColorKey();

            // Check for initial data from URL
            if (window.location.hash) {
                try {
                    const encodedData = window.location.hash.substring(1);
                    const decodedData = atob(encodedData);
                    const initialJson = JSON.parse(decodedData);
                    inputArea.value = JSON.stringify(initialJson, null, 2);
                    loadVisualization();
                } catch (e) {
                    console.error("Failed to load JSON from URL:", e);
                }
            }
        }

        function onWindowResize() {
            camera.aspect = visualizationContainer.clientWidth / visualizationContainer.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(visualizationContainer.clientWidth, visualizationContainer.clientHeight);
            labelRenderer.setSize(visualizationContainer.clientWidth, visualizationContainer.clientHeight);
        }

        function buildVisualization(data, parentPos = new THREE.Vector3(0, 0, 0), level = 0, index = 0) {
            const cubeSize = 1;
            const spacing = 0.5;
            const xOffset = (level % 2 === 0 ? 1 : -1) * (cubeSize + spacing) * index;
            const yOffset = (level % 2 === 0 ? -1 : 1) * (cubeSize + spacing) * index;
            const zOffset = (cubeSize + spacing) * level;

            const pos = new THREE.Vector3(parentPos.x + xOffset, parentPos.y + yOffset, parentPos.z + zOffset);

            const fileExtension = data.name.split('.').pop();
            const color = data.type === 'folder' ? colorMap.folder : (colorMap[fileExtension] || colorMap.default);
            const geometry = new THREE.BoxGeometry(cubeSize, cubeSize, cubeSize);
            const material = new THREE.MeshLambertMaterial({ color: color });

            if (data.type === 'folder') {
                material.transparent = true;
                material.opacity = 0.5;
                const edges = new THREE.EdgesGeometry(geometry);
                const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: color }));
                line.position.copy(pos);
                scene.add(line);

                // Use a standard box for interaction
                const cube = new THREE.Mesh(geometry, material);
                cube.position.copy(pos);
                cube.userData = data;
                scene.add(cube);
                cubeMap.set(cube.uuid, cube.userData);

            } else {
                const cube = new THREE.Mesh(geometry, material);
                cube.position.copy(pos);
                cube.userData = data;
                scene.add(cube);
                cubeMap.set(cube.uuid, cube.userData);
            }

            // Add label
            const labelDiv = document.createElement('div');
            labelDiv.className = 'cube-label';
            labelDiv.textContent = data.name;
            const label = new CSS2DObject(labelDiv);
            label.position.set(pos.x, pos.y + cubeSize / 2 + 0.1, pos.z);
            scene.add(label);

            if (data.children) {
                let currentPos = new THREE.Vector3().copy(pos);
                data.children.forEach((child, i) => {
                    buildVisualization(child, currentPos, level + 1, i);
                });
            }
        }

        function updateVisualization(data) {
            // Clear previous scene
            while(scene.children.length > 0) {
                scene.remove(scene.children[0]);
            }
            cubeMap.clear();

            // Re-add lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);

            // Rebuild visualization
            currentRepoData = data;
            buildVisualization(currentRepoData);
        }

        function loadVisualization() {
            try {
                const data = JSON.parse(inputArea.value);
                if (historyIndex < history.length - 1) {
                    history = history.slice(0, historyIndex + 1);
                }
                history.push(data);
                historyIndex++;
                updateVisualization(data);
                updateHistoryButtons();
            } catch (e) {
                alert('Invalid JSON! Please check the format.');
            }
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                const data = history[historyIndex];
                updateVisualization(data);
                inputArea.value = JSON.stringify(data, null, 2);
                updateHistoryButtons();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                const data = history[historyIndex];
                updateVisualization(data);
                inputArea.value = JSON.stringify(data, null, 2);
                updateHistoryButtons();
            }
        }

        function updateHistoryButtons() {
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= history.length - 1;
        }

        function downloadImage() {
            renderer.render(scene, camera);
            const dataURL = renderer.domElement.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = 'repo-viz.png';
            link.href = dataURL;
            link.click();
        }

        function shareLink() {
            if (currentRepoData) {
                const encodedData = btoa(JSON.stringify(currentRepoData));
                const shareableURL = `${window.location.origin}${window.location.pathname}#${encodedData}`;
                navigator.clipboard.writeText(shareableURL)
                    .then(() => alert('Shareable link copied to clipboard!'))
                    .catch(() => alert('Failed to copy link.'));
            }
        }

        function onPointerDown(event) {
            mouse.x = (event.clientX / visualizationContainer.clientWidth) * 2 - 1;
            mouse.y = -(event.clientY / visualizationContainer.clientHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);

            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;
                const data = clickedObject.userData;

                if (data && data.type === 'file') {
                    displayFileDetails(data);
                } else if (data && data.type === 'folder') {
                    // This is a simple interaction, could be more complex
                    alert(`Clicked folder: ${data.name}`);
                }
            }
        }

        function displayFileDetails(fileData) {
            detailsContent.textContent = JSON.stringify(fileData, null, 2);
            detailsModal.style.display = 'block';
        }

        function updateColorKey() {
            colorKey.innerHTML = '';
            const keyData = [
                { type: 'Folder', color: colorMap.folder },
                { type: 'File (generic)', color: colorMap.default },
                { type: 'JavaScript (.js)', color: colorMap.js },
                { type: 'HTML (.html)', color: colorMap.html },
                { type: 'CSS (.css)', color: colorMap.css },
                { type: 'JSON (.json)', color: colorMap.json }
            ];

            keyData.forEach(item => {
                const keyItem = document.createElement('div');
                keyItem.className = 'key-item';
                keyItem.innerHTML = `
                    <div class="key-box" style="background-color: ${item.color};"></div>
                    <span>${item.type}</span>
                `;
                colorKey.appendChild(keyItem);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
            labelRenderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
